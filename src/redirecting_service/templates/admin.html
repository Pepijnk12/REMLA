<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <style>
    .flex-horizontal {
      display: flex;
    }

    #model-selector {
        min-width: 150px;
    }
  </style>
</head>

<body>
<div class="container pt-3">
  <label>Active model:</label>
  <div class="flex-horizontal">
    <div>
      <select id="model-selector" class="form-control model-select">
        <option value="A">Model A</option>
        <option value="B">Model B</option>
      </select>
    </div>
    <button class="btn btn-outline-secondary ml-2" type="button"
      onclick="setActiveModel(document.getElementById('model-selector').value)">Save
    </button>
    <div class="ml-2">
      <div id="loading-model-selected" class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <div id="success-model-selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
          <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
        </svg>
      </div>
      <div id="error-model-selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
          <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="input-group my-3">
    <input type="text" class="form-control" placeholder="Image url, e.g. ghcr.io/pepijnk12/remla:inference-api-latest" id="image-url-input">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button"
              onclick="deployImage(document.getElementById('image-url-input').value)">Deploy image
      </button>
    </div>
  </div>
  <div>
    <h4 id="image-deployed">Image deployment triggered</h4>
  </div>
  <h5 class="mt-3">Logs</h5>
  <div id="model-logs">

  </div>

</div>
<script>

    function deployImage(imageUrl){
        fetch("http://localhost:8080/deploy-image", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({imageUrl: imageUrl})
        })
            .then(res => res.json())
            .then(responseData => {
                document.getElementById('image-deployed').style.display = "block";
            });
    }

    function hideAllStatusElements(){
        document.getElementById('loading-model-selected').style.display = "none";
        document.getElementById('success-model-selected').style.display = "none";
        document.getElementById('error-model-selected').style.display = "none";
        document.getElementById('image-deployed').style.display = "none";
    }


    function setActiveModel(value) {
        document.getElementById('loading-model-selected').style.display = "block";

        fetch("http://localhost:30000/set-active-model", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: value})
        })
            .then(res => res.json())
            .then(responseData => {
                hideAllStatusElements();
                if (responseData.success){
                   document.getElementById('success-model-selected').style.display = "block";
                } else {
                   document.getElementById('error-model-selected').style.display = "block";
                }
            });
    }

    function getActiveModel() {
        fetch("http://0.0.0.0:30000/active-model", {
            method: "GET",
            headers: {'Content-Type': 'application/json'},
        })
            .then(res => res.json())
            .then(responseData => {
                document.getElementById('model-selector').value = responseData.activeModel;
            });
    }

    function objToString (obj) {
      let str = '';
      for (const [p, val] of Object.entries(obj)) {
          str += `${p}: ${val}<br>`;
      }
      return str.slice(0, str.length - 4);
    }

    function getLogs() {
        fetch("http://0.0.0.0:30000/logs", {
            method: "GET",
            headers: {'Content-Type': 'application/json'},
        })
            .then(res => res.json())
            .then(responseData => {
                if (responseData){
                    document.getElementById('model-logs').innerHTML = responseData.map(function(item) {
                      return objToString(item);
                    }).join("<br><br>");
                }
            });
    }
    getLogs()
    hideAllStatusElements()
    getActiveModel()
</script>
<script>
</script>
</body>
</html>
