<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <style>
    .flex-horizontal {
      display: flex;
    }

    #model-selector {
        min-width: 150px;
    }
  </style>
</head>

<body>
<div class="container pt-3">

  <div class="d-flex">
    <div class="p-2 flex-shrink-1">
      <img src="./assets/undraw_performance_overview_re_mqrq.svg" alt="heading" width="130"/>
    </div>
    <div class="p-2  w-100">
      <h5 class="text-center"> <b>CS4295</b> Release Engineering for Machine Learning Applications (REMLA 2021 - 2022) </h5>
      <h1 class="text-center"> Admin panel | Stack overflow tag predictor</h1>
    </div>
  </div>


  <label>Active model:&nbsp;</label><label id="active-model"></label>
  <div class="flex-horizontal">
    <div>
      <select id="model-selector" class="form-control model-select">
        <option>No models loaded</option>>
      </select>
    </div>
    <button class="btn btn-outline-secondary ml-2" type="button"
      onclick="setActiveModel(document.getElementById('model-selector').value)">Set Active
    </button>
    <div class="ml-2">
      <div id="loading-model-selected" class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <div id="success-model-selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
          <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
        </svg>
      </div>
      <div id="error-model-selected">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
          <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="input-group my-3">
    <input type="text" class="form-control" placeholder="Model version, e.g. 1.4.0" id="image-url-input">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button"
              onclick="deployImage(document.getElementById('image-url-input').value)"> 
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-parachute" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000000" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M22 12a10 10 0 1 0 -20 0" />
                <path d="M22 12c0 -1.66 -1.46 -3 -3.25 -3c-1.8 0 -3.25 1.34 -3.25 3c0 -1.66 -1.57 -3 -3.5 -3s-3.5 1.34 -3.5 3c0 -1.66 -1.46 -3 -3.25 -3c-1.8 0 -3.25 1.34 -3.25 3" />
                <path d="M2 12l10 10l-3.5 -10" />
                <path d="M15.5 12l-3.5 10l10 -10" />
              </svg> Deploy image
      </button>
    </div>
  </div>
  <div>
    <h4 id="image-deployed">Image deployment triggered</h4>
  </div>
  <h5 class="mt-3">Logs</h5>
  <div id="model-logs"></div>

</div>
<script>
    // I notice it's actually using version string here. If you want to add url implementation the api need to be changed directly
    function deployImage(versionString){
        fetch("http://localhost:30001/deploy-image", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({version: versionString})
        })
            .then(res => res.json())
            .then(responseData => {
                document.getElementById('image-deployed').style.display = "block";
            });
    }

    function hideAllStatusElements(){
        document.getElementById('loading-model-selected').style.display = "none";
        document.getElementById('success-model-selected').style.display = "none";
        document.getElementById('error-model-selected').style.display = "none";
        document.getElementById('image-deployed').style.display = "none";
    }


    function setActiveModel(model_version) {
        document.getElementById('loading-model-selected').style.display = "block";

        fetch("http://localhost:30001/set-active-model", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model_version})
        })
            .then(res => res.json())
            .then(responseData => {
                hideAllStatusElements();
                if (responseData.success){
                   document.getElementById('success-model-selected').style.display = "block";
                   document.getElementById('active-model').textContent = model_version
                } else {
                   document.getElementById('error-model-selected').style.display = "block";
                }
            });
    }

    function getActiveModel() {
        fetch("http://localhost:30001/active-model", {
            method: "GET",
            headers: {'Content-Type': 'application/json'},
        })
            .then(res => res.json())
            .then(responseData => {
                document.getElementById('model-selector').value = responseData.activeModel;
                document.getElementById('active-model').textContent = responseData.activeModel
            });
    }

    function objToString (obj) {
      let str = '';
      for (const [p, val] of Object.entries(obj)) {
          str += `${p}: ${val}<br>`;
      }
      return str.slice(0, str.length - 4);
    }

    function getLogs() {
        fetch("http://localhost:30001/logs", {
            method: "GET",
            headers: {'Content-Type': 'application/json'},
        })
            .then(res => res.json())
            .then(responseData => {
                if (responseData){
                    document.getElementById('model-logs').innerHTML = responseData.map(function(item) {
                      return objToString(item);
                    }).join("<br><br>");
                }
            });
    }

    function loadModels() {
        fetch("http://localhost:30001/get-all-models", {
            method: "GET",
            headers: {'Content-Type': 'application/json'},
        })
            .then(res => res.json())
            .then(responseData => {
                if (responseData){
                    let optionList = "";
                    const optionArray = responseData.models
                    for (let i=0; i< optionArray.length;i++){
                       optionList += "<option value='"+optionArray[i]+"'>"+optionArray[i]+"</option>"
                    }
                    document.getElementById('model-selector').innerHTML = optionList;
                }
            });
    }

    getLogs()
    hideAllStatusElements()
    loadModels()
    getActiveModel()
</script>
<script>
</script>
</body>
</html>
